<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Family Chat</title>
    <style>
        :root { --bg: #0d1117; --card: #161b22; --primary: #238636; --text: #c9d1d9; --border: #30363d; --danger: #da3633; }
        * { box-sizing: border-box; }
        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif; background: var(--bg); color: var(--text); height: 100dvh; display: flex; flex-direction: column; overflow: hidden; }

        /* Setup / Login / Signup */
        #setup, #signup-ui { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; padding: 20px; }
        .form-card { background: var(--card); padding: 25px; border-radius: 12px; border: 1px solid var(--border); width: 100%; max-width: 350px; display: flex; flex-direction: column; gap: 12px; }
        input, select { width: 100%; height: 45px; padding: 0 12px; border-radius: 8px; border: 1px solid var(--border); background: #0d1117; color: white; outline: none; font-size: 14px; }
        button { height: 45px; background: var(--primary); border: none; border-radius: 8px; color: white; font-weight: bold; cursor: pointer; transition: opacity 0.2s; }
        button:active { opacity: 0.7; }

        /* Chat Layout */
        header { background: var(--card); padding: 10px 15px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; z-index: 10; }
        #chat-ui { display: none; flex-direction: column; height: 100dvh; }
        #messages { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 12px; scroll-behavior: smooth; }
        .msg { background: var(--card); padding: 10px; border-radius: 12px; max-width: 85%; width: fit-content; border: 1px solid var(--border); word-break: break-word; }
        .msg.me { align-self: flex-end; background: #21262d; }
        .msg img { max-width: 100%; border-radius: 8px; margin-top: 5px; display: block; }
        .input-area { padding: 15px; background: var(--card); display: flex; gap: 10px; border-top: 1px solid var(--border); align-items: flex-end; }
        #msg-in { flex: 1; min-height: 45px; max-height: 120px; padding: 12px; border-radius: 8px; border: 1px solid var(--border); background: #0d1117; color: white; outline: none; overflow-y: auto; }

        /* Notification Dot */
        .admin-btn-wrapper { position: relative; display: inline-block; }
        #notif-dot { position: absolute; top: -2px; right: -2px; width: 12px; height: 12px; background: #ff453a; border-radius: 50%; border: 2px solid var(--card); display: none; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { transform: scale(0.9); } 50% { transform: scale(1.2); } 100% { transform: scale(0.9); } }

        /* Admin Modal Pop-up */
        #admin-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 2000; display: none; align-items: center; justify-content: center; padding: 15px; }
        .modal-content { background: var(--card); width: 100%; max-width: 480px; max-height: 85vh; border-radius: 12px; border: 1px solid var(--border); display: flex; flex-direction: column; }
        .modal-header { padding: 15px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; font-weight: bold; }
        .modal-body { flex: 1; overflow-y: auto; padding: 15px; }
        .admin-item { background: #0d1117; border: 1px solid var(--border); border-radius: 8px; padding: 12px; margin-bottom: 12px; }
        .edit-controls { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 10px; }

        /* Utilities */
        #action-overlay { position: fixed; inset: 0; background: rgba(13, 17, 23, 0.95); z-index: 3000; display: none; flex-direction: column; align-items: center; justify-content: center; }
        .spinner { width: 40px; height: 40px; border: 4px solid #30363d; border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .hidden { display: none !important; }
        .btn-icon { background: #30363d; color: white; border: 1px solid var(--border); height: 35px; width: 35px; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 18px; }
    </style>
</head>
<body>

    <div id="action-overlay"><div class="spinner"></div><div id="action-text" style="margin-top:10px;">Processing...</div></div>

    <div id="admin-modal">
        <div class="modal-content">
            <div class="modal-header">
                <span>Management Panel</span>
                <button onclick="closeAdmin()" style="background:none; color:white; font-size:24px; border:none; cursor:pointer;">&times;</button>
            </div>
            <div class="modal-body">
                <button onclick="clearChat()" style="background:var(--danger); width:100%; margin-bottom:15px; height: 35px;">Clear Chat history</button>
                <div id="admin-list"></div>
            </div>
        </div>
    </div>

    <div id="setup">
        <div class="form-card">
            <h2 style="text-align: center;">Family Chat</h2>
            <input type="text" id="user-in" placeholder="Username">
            <input type="password" id="pass-in" placeholder="Password">
            <button onclick="handleLoginClick()">Join Chat</button>
            <span style="color:#58a6ff; font-size:13px; cursor:pointer; text-align:center;" onclick="toggleScreens('signup')">Request Access</span>
            <div style="color: #8b949e; font-size: 11px; text-decoration: underline; cursor: pointer; margin-top: 15px; text-align: center;" onclick="fullReset()">Reset App</div>
        </div>
    </div>

    <div id="signup-ui" class="hidden">
        <div class="form-card">
            <h2>Sign Up</h2>
            <input type="text" id="reg-user" placeholder="Username">
            <input type="password" id="reg-pass" placeholder="Password">
            <div id="color-grid" style="display:grid; grid-template-columns: repeat(5, 1fr); gap: 5px;"></div>
            <button onclick="handleSignup()">Submit Request</button>
            <span style="color:#58a6ff; font-size:13px; cursor:pointer; text-align:center;" onclick="toggleScreens('login')">Back to Login</span>
        </div>
    </div>

    <div id="chat-ui">
        <header>
            <span style="font-weight: bold; color: var(--primary);">Family Chat</span>
            <div style="display:flex; gap:8px;">
                <div class="admin-btn-wrapper">
                    <button id="admin-btn" class="btn-icon hidden" onclick="openAdmin()">‚öôÔ∏è</button>
                    <div id="notif-dot"></div>
                </div>
                <button class="btn-icon" onclick="location.reload()">‚Üª</button>
                <button onclick="logout()" style="background:var(--danger); border:none; color:white; padding:0 12px; border-radius:6px; font-weight:bold;">Exit</button>
            </div>
        </header>
        <div id="messages"></div>
        <div class="input-area">
            <div id="msg-in" contenteditable="true"></div>
            <button onclick="send()" style="width:70px; height:45px;">Send</button>
        </div>
    </div>

    <script>
        // Update this URL with your latest deployment link
        const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxC_P-2NFOI1uvkRvViMGOc_amN5rt2kry0LipM0r_E9gMXnVa6opUS8sH-nmiOUO_W/exec";
        
        let myUser = "", myColor = "#238636", myTag = "", refreshInterval, selectedColor = "#238636";
        const colors = ['#238636','#39ff14','#00d4ff','#ff85a2','#ff9100','#f8e71c','#bd10e0','#9013fe','#50e3c2','#ff5733','#c70039','#900c3f','#581845','#1abc9c','#2ecc71','#3498db','#9b59b6','#f1c40f','#e67e22','#e74c3c'];

        window.onload = () => {
            const grid = document.getElementById('color-grid');
            if(grid) {
                colors.forEach(c => {
                    const d = document.createElement('div'); d.style.background = c; d.style.height="30px"; d.style.borderRadius="4px"; d.onclick = () => selectedColor = c;
                    grid.appendChild(d);
                });
            }
            document.getElementById('msg-in').addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); send(); }
            });
            const savedU = localStorage.getItem('chat_user'), savedP = localStorage.getItem('chat_pass');
            if (savedU && savedP) attemptLogin(savedU, savedP);
        };

        async function attemptLogin(u, p) {
            showSpinner("Logging in...");
            try {
                const res = await fetch(`${WEB_APP_URL}?action=login&user=${encodeURIComponent(u)}&pass=${encodeURIComponent(p)}`);
                const data = await res.json();
                if (data.success) {
                    myUser = u; myColor = data.color; myTag = (data.tag || "").toUpperCase();
                    localStorage.setItem('chat_user', u); localStorage.setItem('chat_pass', p);
                    if (myTag === "ADMIN" || myTag === "PARENT") document.getElementById('admin-btn').classList.remove('hidden');
                    document.getElementById('setup').classList.add('hidden');
                    document.getElementById('chat-ui').style.display = 'flex';
                    refreshInterval = setInterval(refresh, 4000); refresh();
                } else alert(data.error || "Login Failed");
            } catch(e) { alert("Connection Error. Please check your Web App URL."); }
            hideSpinner();
        }

        async function refresh() {
            try {
                const res = await fetch(`${WEB_APP_URL}?action=refresh&v=${Date.now()}`);
                const data = await res.json();
                
                // Toggle Notification Dot
                const dot = document.getElementById('notif-dot');
                if (data.hasRequests && (myTag === "ADMIN" || myTag === "PARENT")) {
                    dot.style.display = 'block';
                } else {
                    dot.style.display = 'none';
                }

                const box = document.getElementById('messages');
                const shouldScroll = box.scrollTop + box.offsetHeight >= box.scrollHeight - 50;
                box.innerHTML = "";
                data.messages.forEach(m => renderMessage(m.username, m.message, m.username === myUser, m.color, m.tag));
                if (shouldScroll) box.scrollTop = box.scrollHeight;
            } catch(e) {}
        }

        async function openAdmin() {
            document.getElementById('admin-modal').style.display = 'flex';
            const list = document.getElementById('admin-list');
            list.innerHTML = "<div>Fetching member list...</div>";
            try {
                const res = await fetch(`${WEB_APP_URL}?action=get_users&user=${encodeURIComponent(myUser)}&pass=${encodeURIComponent(localStorage.getItem('chat_pass'))}&v=${Date.now()}`);
                const users = await res.json();
                list.innerHTML = "";
                users.forEach(u => {
                    const div = document.createElement('div'); div.className = "admin-item";
                    const isBanned = (u.status || "").toUpperCase() === "BANNED";
                    div.innerHTML = `
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <b style="color:${u.color || '#fff'}">${u.user}</b> 
                            <span style="font-size:10px; background:${u.color}33; padding:2px 6px; border-radius:4px;">${u.tag}</span>
                        </div>
                        <div class="edit-controls">
                            <select onchange="updateUser('${u.user}', 'tag', this.value)">
                                <option value="" selected disabled>Change Tag</option>
                                <option value="MEMBER">MEMBER</option>
                                <option value="PARENT">PARENT</option>
                                <option value="ADMIN">ADMIN</option>
                            </select>
                            <input type="color" value="${u.color}" onchange="updateUser('${u.user}', 'color', this.value)">
                        </div>
                        <div style="margin-top:10px; display:flex; gap:5px;">
                            ${u.isReq ? `<button onclick="adminAction('${u.user}','approve')" style="background:green; font-size:10px; height:28px; flex:1; border:none; color:white; border-radius:4px;">Approve</button>` : 
                            `<button onclick="updateUser('${u.user}','status','${isBanned ? 'Active' : 'Banned'}')" style="background:${isBanned ? '#238636' : '#f8e71c'}; color:${isBanned ? 'white' : 'black'}; font-size:10px; height:28px; flex:1; border:none; border-radius:4px;">${isBanned ? 'Unban' : 'Ban'}</button>`}
                            <button onclick="adminAction('${u.user}','deny')" style="background:var(--danger); font-size:10px; height:28px; flex:1; border:none; color:white; border-radius:4px;">Delete</button>
                        </div>`;
                    list.appendChild(div);
                });
            } catch (e) { list.innerHTML = "Error loading list."; }
        }

        function closeAdmin() { document.getElementById('admin-modal').style.display = 'none'; }

        async function updateUser(target, type, value) {
            showSpinner("Updating...");
            const data = { action: "update_user_details", target: target };
            if (type === 'tag') data.newTag = value;
            if (type === 'color') data.newColor = value;
            if (type === 'status') data.newStatus = value;
            fetch(WEB_APP_URL, { method: "POST", mode: "no-cors", body: JSON.stringify(data) });
            setTimeout(() => { hideSpinner(); openAdmin(); }, 1500);
        }

        async function clearChat() {
            if (!confirm("Delete all chat messages for everyone?")) return;
            showSpinner("Clearing...");
            fetch(WEB_APP_URL, { method: "POST", mode: "no-cors", body: JSON.stringify({action: "clear_chat"}) });
            setTimeout(() => { hideSpinner(); closeAdmin(); refresh(); }, 1800);
        }

        async function adminAction(target, action) {
            showSpinner("Processing...");
            fetch(WEB_APP_URL, { method: "POST", mode: "no-cors", body: JSON.stringify({action: "admin_manage", target: target, subAction: action}) });
            setTimeout(() => { hideSpinner(); openAdmin(); }, 1500);
        }

        async function handleSignup() {
            showSpinner("Submitting...");
            fetch(WEB_APP_URL, { method: "POST", mode: "no-cors", body: JSON.stringify({action:"signup", username:document.getElementById('reg-user').value, password:document.getElementById('reg-pass').value, color:selectedColor}) });
            setTimeout(() => { alert("Request Sent! Wait for approval."); hideSpinner(); toggleScreens('login'); }, 1500);
        }

        function toggleScreens(scr) {
            document.getElementById('setup').classList.add('hidden'); document.getElementById('signup-ui').classList.add('hidden'); document.getElementById('chat-ui').style.display = 'none';
            if (scr === 'login') document.getElementById('setup').classList.remove('hidden');
            if (scr === 'signup') document.getElementById('signup-ui').classList.remove('hidden');
            if (scr === 'chat') document.getElementById('chat-ui').style.display = 'flex';
        }

        function showSpinner(t) { document.getElementById('action-text').innerText = t; document.getElementById('action-overlay').style.display = 'flex'; }
        function hideSpinner() { document.getElementById('action-overlay').style.display = 'none'; }
        function logout() { localStorage.clear(); location.reload(); }
        function fullReset() { localStorage.clear(); sessionStorage.clear(); location.reload(); }

        async function send() {
            const i = document.getElementById('msg-in'); let m = i.innerText; if (!m.trim()) return; i.innerHTML = "";
            renderMessage(myUser, m, true, myColor, myTag);
            fetch(WEB_APP_URL, { method: "POST", mode: "no-cors", body: JSON.stringify({username:myUser, message:m, color:myColor, tag:myTag}) });
        }

        function renderMessage(u, t, me, c, tag) {
            const box = document.getElementById('messages'), div = document.createElement('div');
            div.className = `msg ${me ? 'me' : ''}`; div.style[me ? 'borderRight' : 'borderLeft'] = `4px solid ${c}`;
            
            const imgR = /(https?:\/\/.*\.(?:png|jpg|jpeg|gif|webp))/i;
            const urlR = /(https?:\/\/[^\s]+)/g;
            let content = t;

            if (imgR.test(t.trim())) {
                content = `<img src="${t.trim()}" onload="document.getElementById('messages').scrollTop = document.getElementById('messages').scrollHeight;">`;
            } else if (urlR.test(t.trim())) {
                content = t.replace(urlR, (url) => {
                    const dom = new URL(url).hostname;
                    return `<div style="margin-top:8px;">
                        <a href="${url}" target="_blank" rel="noopener" style="text-decoration:none; color:inherit;">
                            <div style="background: rgba(0,0,0,0.2); border: 1px solid var(--border); border-radius: 8px; padding: 10px; display: flex; align-items: center; gap: 10px;">
                                <div style="font-size: 20px;">üîó</div>
                                <div style="overflow: hidden;">
                                    <div style="font-size: 13px; font-weight: bold; color: #58a6ff;">${dom}</div>
                                    <div style="font-size: 11px; opacity: 0.7; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${url}</div>
                                </div>
                            </div>
                        </a>
                    </div>`;
                });
            }
            div.innerHTML = `<b style="color:${c}; font-size:11px;">${u} <span style="font-size:8px; opacity:0.5; background:rgba(255,255,255,0.1); padding:1px 3px; border-radius:3px; margin-left:4px;">${tag}</span></b><div style="margin-top:4px;">${content}</div>`;
            box.appendChild(div);
        }

        function handleLoginClick() {
            const u = document.getElementById('user-in').value;
            const p = document.getElementById('pass-in').value;
            if(u && p) attemptLogin(u,p);
        }
    </script>
</body>
</html>
