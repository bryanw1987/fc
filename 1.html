<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Family Chat</title>
    <style>
        :root { --bg: #0d1117; --card: #161b22; --primary: #238636; --text: #c9d1d9; --border: #30363d; }
        * { box-sizing: border-box; }
        body { margin: 0; font-family: -apple-system, sans-serif; background: var(--bg); color: var(--text); height: 100dvh; display: flex; flex-direction: column; overflow: hidden; }

        #setup, #signup-ui, #admin-ui { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; padding: 20px; }
        #admin-ui { justify-content: flex-start; overflow-y: auto; display: none; padding-top: 20px; }
        
        .form-card { background: var(--card); padding: 25px; border-radius: 12px; border: 1px solid var(--border); width: 100%; max-width: 350px; display: flex; flex-direction: column; gap: 12px; }
        input, select { width: 100%; height: 45px; padding: 0 12px; border-radius: 8px; border: 1px solid var(--border); background: #0d1117; color: white; outline: none; font-size: 16px; }
        button { height: 45px; background: var(--primary); border: none; border-radius: 8px; color: white; font-weight: bold; cursor: pointer; transition: opacity 0.2s; }
        
        .color-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; margin: 10px 0; }
        .color-box { width: 100%; aspect-ratio: 1/1; border-radius: 4px; cursor: pointer; border: 2px solid transparent; }
        .color-box.selected { border-color: white; transform: scale(1.1); }

        header { background: var(--card); padding: 10px 15px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        #chat-ui { display: none; flex-direction: column; height: 100dvh; }
        #messages { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 12px; }
        
        .msg { background: var(--card); padding: 10px; border-radius: 12px; max-width: 85%; width: fit-content; border: 1px solid var(--border); word-break: break-word; }
        .msg.me { align-self: flex-end; background: #21262d; }
        .msg img { max-width: 100%; border-radius: 8px; margin-top: 8px; display: block; border: 1px solid var(--border); }
        
        .sys-msg { align-self: center; color: #00a8ff; font-size: 13px; font-weight: bold; margin: 5px 0; }
        .tag-label { font-size: 0.65rem; font-weight: 800; opacity: 0.8; background: rgba(255,255,255,0.1); padding: 1px 4px; border-radius: 4px; margin-left: 5px; }
        
        .input-area { padding: 15px; background: var(--card); display: flex; gap: 10px; border-top: 1px solid var(--border); align-items: flex-end; }
        #msg-in { flex: 1; min-height: 45px; max-height: 120px; padding: 12px; border-radius: 8px; border: 1px solid var(--border); background: #0d1117; color: white; outline: none; font-size: 16px; overflow-y: auto; white-space: pre-wrap; }
        #msg-in:empty:before { content: "Message..."; color: #8b949e; }

        /* Admin UI styles */
        .admin-item { background: var(--card); border: 1px solid var(--border); border-radius: 8px; padding: 12px; margin-bottom: 10px; width: 100%; max-width: 400px; }
        .admin-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .admin-actions { display: flex; gap: 5px; }
        .admin-actions select { height: 32px; font-size: 12px; }
        .search-container { position: sticky; top: 0; background: var(--bg); padding: 10px 0; width: 100%; max-width: 400px; z-index: 5; }

        /* Spinner & Overlays */
        #action-overlay { position: fixed; inset: 0; background: rgba(13, 17, 23, 0.95); z-index: 1000; display: none; flex-direction: column; align-items: center; justify-content: center; }
        #loading-overlay { position: fixed; inset: 0; background: var(--bg); z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 20px; }
        .spinner { width: 45px; height: 45px; border: 4px solid #30363d; border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .hidden { display: none !important; }
        .header-btns { display: flex; align-items: center; gap: 8px; }
        .btn-icon { background: #30363d; color: white; border: 1px solid var(--border); height: 30px; width: 35px; border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
    </style>
</head>
<body>

    <div id="loading-overlay" class="hidden">
        <div class="spinner"></div>
        <div>Connecting to Family Server...</div>
        <button onclick="logout()" style="background: transparent; color: #8b949e; border: 1px solid #30363d; height: 35px; font-size: 12px; margin-top: 10px; padding: 0 15px; border-radius: 8px;">Cancel & Reset</button>
    </div>

    <div id="action-overlay">
        <div class="spinner" style="margin-bottom: 15px;"></div>
        <div id="action-text">Processing...</div>
    </div>

    <div id="setup">
        <div class="form-card">
            <h2 style="text-align: center;">Family Chat</h2>
            <input type="text" id="user-in" placeholder="Username">
            <input type="password" id="pass-in" placeholder="Password">
            <button onclick="handleLoginClick()">Join Chat</button>
            <span style="color:#58a6ff; font-size:14px; cursor:pointer; text-align:center;" onclick="toggleScreens('signup')">Need an account? Sign up</span>
        </div>
    </div>

    <div id="signup-ui" class="hidden">
        <div class="form-card">
            <h2>Join the Family</h2>
            <input type="text" id="reg-user" placeholder="Choose Username">
            <input type="password" id="reg-pass" placeholder="Choose Password">
            <div style="font-size: 12px; color: #8b949e;">Choose your message color:</div>
            <div class="color-grid" id="color-grid"></div>
            <button onclick="handleSignup()">Submit Request</button>
            <span style="color:#58a6ff; font-size:14px; cursor:pointer; text-align:center;" onclick="toggleScreens('login')">Back to Login</span>
        </div>
    </div>

    <div id="admin-ui" class="hidden">
        <div class="search-container">
            <h2>Manage Members</h2>
            <input type="text" id="admin-search" placeholder="Search by name..." oninput="filterAdminList()">
            <button onclick="toggleScreens('chat')" style="width:100%; background:#30363d; margin-top:10px; height:35px;">Return to Chat</button>
        </div>
        <div id="admin-list" style="width:100%; display:flex; flex-direction:column; align-items:center; padding-bottom:40px;"></div>
    </div>

    <div id="chat-ui">
        <header>
            <span style="font-weight: bold; color: var(--primary);">Family Chat</span>
            <div class="header-btns">
                <span id="header-user" style="font-size: 11px; opacity: 0.7;"></span>
                <button id="admin-btn" class="btn-icon hidden" onclick="openAdmin()">‚öôÔ∏è</button>
                <button class="btn-icon" onclick="location.reload()">‚Üª</button>
                <button onclick="logout()" style="background:#da3633; height:30px; font-size:12px; padding:0 10px; border-radius:4px; border:none; color:white; font-weight:bold;">Exit</button>
            </div>
        </header>
        <div id="messages"></div>
        <div class="input-area">
            <div id="msg-in" contenteditable="true"></div>
            <button onclick="send()" style="width:70px; height:45px;">Send</button>
        </div>
    </div>

    <script>
        // REPLACE THIS WITH YOUR DEPLOYED WEB APP URL
        const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbyBAbm9Dw4kYuJCoqhUm9p2ytKQ1yttdLRJeLG2tO0AjSmSz8TNOOV23NSWoEhLkX93/exec";
        
        let myUser = "", myColor = "#238636", myTag = "", refreshInterval, selectedColor = "#238636", allUsersCache = [];

        const colors = ['#238636','#39ff14','#00d4ff','#ff85a2','#ff9100','#f8e71c','#bd10e0','#9013fe','#50e3c2','#ff5733','#c70039','#900c3f','#581845','#1abc9c','#2ecc71','#3498db','#9b59b6','#f1c40f','#e67e22','#e74c3c'];

        window.onload = () => {
            const grid = document.getElementById('color-grid');
            colors.forEach(c => {
                const d = document.createElement('div');
                d.className = 'color-box'; d.style.backgroundColor = c;
                d.onclick = () => { 
                    document.querySelectorAll('.color-box').forEach(b => b.classList.remove('selected'));
                    d.classList.add('selected'); selectedColor = c;
                };
                grid.appendChild(d);
            });

            document.getElementById('msg-in').addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); send(); }
            });

            autoLogin();
        };

        async function autoLogin() {
            const u = localStorage.getItem('chat_user'), p = localStorage.getItem('chat_pass');
            if (u && p) {
                document.getElementById('loading-overlay').classList.remove('hidden');
                const ok = await attemptLogin(u, p, true);
                document.getElementById('loading-overlay').classList.add('hidden');
            }
        }

        async function attemptLogin(user, pass, isAuto) {
            try {
                const res = await fetch(`${WEB_APP_URL}?action=login&user=${encodeURIComponent(user)}&pass=${encodeURIComponent(pass)}`);
                const data = await res.json();
                if (data.success) {
                    localStorage.setItem('chat_user', user); localStorage.setItem('chat_pass', pass);
                    myUser = user; myColor = data.color; myTag = data.tag;
                    document.getElementById('header-user').innerText = myUser;
                    if (myTag === "ADMIN") document.getElementById('admin-btn').classList.remove('hidden');
                    document.getElementById('setup').classList.add('hidden');
                    document.getElementById('chat-ui').style.display = 'flex';
                    refreshInterval = setInterval(refresh, 4000); refresh(); return true;
                }
                return false;
            } catch(e) { return false; }
        }

        async function openAdmin() {
            toggleScreens('admin');
            showSpinner("Loading users...");
            const res = await fetch(`${WEB_APP_URL}?action=get_users&user=${myUser}&pass=${localStorage.getItem('chat_pass')}`);
            allUsersCache = await res.json();
            hideSpinner();
            renderAdminList(allUsersCache);
        }

        function renderAdminList(users) {
            const list = document.getElementById('admin-list');
            list.innerHTML = "";
            users.forEach(u => {
                const item = document.createElement('div');
                item.className = "admin-item";
                item.innerHTML = `
                    <div class="admin-row">
                        <div style="display:flex; align-items:center; gap:10px;">
                            <div style="width:15px; height:15px; border-radius:3px; background:${u.color}; border:1px solid #fff;"></div>
                            <b>${u.user}</b>
                        </div>
                        <span style="font-size:10px; opacity:0.6;">${u.tag}</span>
                    </div>
                    <div class="admin-actions">
                        <select onchange="updateUserInfo('${u.user}', this.value)">
                            <option value="">Update Role</option>
                            <option value="MEMBER">Member</option>
                            <option value="ADMIN">Admin</option>
                            <option value="BANNED">Ban</option>
                        </select>
                        ${u.tag === 'PENDING' ? `<button onclick="adminAction('${u.user}', 'approve')" style="background:#238636; height:32px; font-size:11px; padding:0 8px;">Approve</button>` : ''}
                        <button onclick="adminAction('${u.user}', 'deny')" style="background:#da3633; height:32px; width:35px;">√ó</button>
                    </div>
                `;
                list.appendChild(item);
            });
        }

        function filterAdminList() {
            const query = document.getElementById('admin-search').value.toLowerCase();
            const filtered = allUsersCache.filter(u => u.user.toLowerCase().includes(query));
            renderAdminList(filtered);
        }

        async function updateUserInfo(target, newTag) {
            if (!newTag) return;
            showSpinner("Updating...");
            await fetch(WEB_APP_URL, { method: "POST", mode: "no-cors", body: JSON.stringify({action: "update_user", user: myUser, pass: localStorage.getItem('chat_pass'), target: target, newTag: newTag}) });
            hideSpinner();
            openAdmin();
        }

        async function adminAction(target, action) {
            showSpinner("Processing...");
            await fetch(WEB_APP_URL, { method: "POST", mode: "no-cors", body: JSON.stringify({action: "admin_manage", user: myUser, pass: localStorage.getItem('chat_pass'), target: target, subAction: action}) });
            hideSpinner();
            openAdmin();
        }

        async function handleLoginClick() {
            const u = document.getElementById('user-in').value, p = document.getElementById('pass-in').value;
            if (!u || !p) return alert("Please enter credentials");
            showSpinner("Logging in...");
            const ok = await attemptLogin(u, p, false);
            hideSpinner();
            if (!ok) alert("Login Failed. Credentials incorrect or approval pending.");
        }

        async function handleSignup() {
            const u = document.getElementById('reg-user').value, p = document.getElementById('reg-pass').value;
            if (!u || !p) return alert("Fill all fields");
            showSpinner("Submitting Request...");
            await fetch(WEB_APP_URL, { method: "POST", mode: "no-cors", body: JSON.stringify({action: "signup", username: u, password: p, color: selectedColor}) });
            hideSpinner();
            alert("Request sent! Ask the family admin to approve you.");
            toggleScreens('login');
        }

        function toggleScreens(scr) {
            document.getElementById('setup').classList.add('hidden');
            document.getElementById('signup-ui').classList.add('hidden');
            document.getElementById('admin-ui').classList.add('hidden');
            document.getElementById('chat-ui').style.display = 'none';
            if (scr === 'login') document.getElementById('setup').classList.remove('hidden');
            if (scr === 'signup') document.getElementById('signup-ui').classList.remove('hidden');
            if (scr === 'admin') document.getElementById('admin-ui').classList.remove('hidden');
            if (scr === 'chat') document.getElementById('chat-ui').style.display = 'flex';
        }

        function showSpinner(t) { document.getElementById('action-text').innerText = t; document.getElementById('action-overlay').style.display = 'flex'; }
        function hideSpinner() { document.getElementById('action-overlay').style.display = 'none'; }

        async function logout() { localStorage.clear(); location.reload(); }

        async function send() {
            const i = document.getElementById('msg-in'); let m = i.innerText;
            const pImg = i.querySelector('img'); if (pImg) m = pImg.src;
            if (!m.trim()) return; 
            i.innerHTML = "";
            renderMessage(myUser, m, true, myColor, myTag);
            await fetch(WEB_APP_URL, { method: "POST", mode: "no-cors", body: JSON.stringify({username: myUser, message: m, color: myColor, tag: myTag, isSystem: false}) });
        }

        async function refresh() {
            try {
                const u = localStorage.getItem('chat_user'), p = localStorage.getItem('chat_pass');
                const res = await fetch(`${WEB_APP_URL}?action=refresh&user=${encodeURIComponent(u)}&pass=${encodeURIComponent(p)}`);
                const data = await res.json();
                if (!data.authSuccess) return logout();
                const box = document.getElementById('messages');
                box.innerHTML = "";
                data.messages.forEach(m => renderMessage(m.username, m.message, m.username === myUser, m.color, m.tag));
            } catch(e) {}
        }

        function renderMessage(u, t, me, c, tag) {
            const box = document.getElementById('messages'), div = document.createElement('div');
            if (u === "SYSTEM") { div.className = "sys-msg"; div.innerText = t; } 
            else {
                div.className = `msg ${me ? 'me' : ''}`; div.style[me ? 'borderRight' : 'borderLeft'] = `4px solid ${c}`;
                const imgR = /(https?:\/\/.*\.(?:png|jpg|jpeg|gif|webp|svg|gifv))/i;
                const urlR = /(https?:\/\/[^\s]+)/g;
                let content = t;

                if (imgR.test(t.trim())) {
                    content = `<img src="${t.trim()}" onload="document.getElementById('messages').scrollTop = document.getElementById('messages').scrollHeight;">`;
                } else if (urlR.test(t.trim())) {
                    content = t.replace(urlR, (url) => {
                        const dom = new URL(url).hostname;
                        return `<div style="margin-top:8px;"><a href="${url}" target="_blank" rel="noopener" style="text-decoration:none; color:inherit;"><div style="background: rgba(0,0,0,0.2); border: 1px solid var(--border); border-radius: 8px; padding: 10px; display: flex; align-items: center; gap: 10px;"><div>üîó</div><div><div style="font-size: 13px; font-weight: bold; color: #58a6ff;">${dom}</div><div style="font-size: 11px; opacity: 0.7; overflow: hidden; text-overflow: ellipsis;">${url}</div></div></div></a></div>`;
                    });
                }
                div.innerHTML = `<b style="color:${c}; font-size:12px;">${u} <span class="tag-label">(${tag})</span></b><div style="margin-top:4px;">${content}</div>`;
            }
            box.appendChild(div); box.scrollTop = box.scrollHeight;
        }
    </script>
</body>
</html>
