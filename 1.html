<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Family Chat</title>
    <style>
        :root { --bg: #0d1117; --card: #161b22; --primary: #238636; --text: #c9d1d9; --border: #30363d; }
        * { box-sizing: border-box; }
        body { margin: 0; font-family: -apple-system, sans-serif; background: var(--bg); color: var(--text); height: 100dvh; display: flex; flex-direction: column; overflow: hidden; }
        #setup, #signup-ui, #admin-ui { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; padding: 20px; }
        #admin-ui { justify-content: flex-start; overflow-y: auto; display: none; padding-top: 20px; }
        .form-card { background: var(--card); padding: 25px; border-radius: 12px; border: 1px solid var(--border); width: 100%; max-width: 350px; display: flex; flex-direction: column; gap: 12px; }
        input, select { width: 100%; height: 45px; padding: 0 12px; border-radius: 8px; border: 1px solid var(--border); background: #0d1117; color: white; outline: none; font-size: 16px; }
        button { height: 45px; background: var(--primary); border: none; border-radius: 8px; color: white; font-weight: bold; cursor: pointer; }
        header { background: var(--card); padding: 10px 15px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        #chat-ui { display: none; flex-direction: column; height: 100dvh; }
        #messages { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 12px; }
        .msg { background: var(--card); padding: 10px; border-radius: 12px; max-width: 85%; width: fit-content; border: 1px solid var(--border); word-break: break-word; }
        .msg.me { align-self: flex-end; background: #21262d; }
        .msg img { max-width: 100%; border-radius: 8px; margin-top: 8px; display: block; border: 1px solid var(--border); }
        .input-area { padding: 15px; background: var(--card); display: flex; gap: 10px; border-top: 1px solid var(--border); align-items: flex-end; }
        #msg-in { flex: 1; min-height: 45px; max-height: 120px; padding: 12px; border-radius: 8px; border: 1px solid var(--border); background: #0d1117; color: white; outline: none; overflow-y: auto; }
        #action-overlay { position: fixed; inset: 0; background: rgba(13, 17, 23, 0.95); z-index: 1000; display: none; flex-direction: column; align-items: center; justify-content: center; }
        .spinner { width: 45px; height: 45px; border: 4px solid #30363d; border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .admin-item { background: var(--card); border: 1px solid var(--border); border-radius: 8px; padding: 12px; margin-bottom: 10px; width: 100%; max-width: 400px; }
        .hidden { display: none !important; }
        .btn-icon { background: #30363d; color: white; border: 1px solid var(--border); height: 30px; width: 35px; border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 16px; }
    </style>
</head>
<body>
    <div id="action-overlay"><div class="spinner"></div><div id="action-text" style="margin-top:10px;">Processing...</div></div>
    
    <div id="setup">
        <div class="form-card">
            <h2 style="text-align: center;">Family Chat</h2>
            <input type="text" id="user-in" placeholder="Username">
            <input type="password" id="pass-in" placeholder="Password">
            <button onclick="handleLoginClick()">Join Chat</button>
            <span style="color:#58a6ff; font-size:14px; cursor:pointer; text-align:center;" onclick="toggleScreens('signup')">Request Access</span>
            <div style="color: #8b949e; font-size: 12px; text-decoration: underline; cursor: pointer; margin-top: 15px; text-align: center;" onclick="localStorage.clear(); location.reload();">Clear Cache & Reset</div>
        </div>
    </div>

    <div id="signup-ui" class="hidden">
        <div class="form-card">
            <h2>Sign Up</h2>
            <input type="text" id="reg-user" placeholder="Username">
            <input type="password" id="reg-pass" placeholder="Password">
            <div id="color-grid" style="display:grid; grid-template-columns: repeat(5,1fr); gap:5px;"></div>
            <button onclick="handleSignup()">Submit Request</button>
            <span style="color:#58a6ff; font-size:14px; cursor:pointer; text-align:center;" onclick="toggleScreens('login')">Back to Login</span>
        </div>
    </div>

    <div id="admin-ui" class="hidden">
        <h2>Admin Panel</h2>
        <div style="width: 100%; max-width: 400px; display: flex; flex-direction: column; gap: 10px;">
            <button onclick="toggleScreens('chat')" style="background:#30363d;">Back to Chat</button>
            <button onclick="clearChat()" style="background:#da3633;">Clear All Messages</button>
        </div>
        <hr style="width: 100%; max-width: 400px; border: 0; border-top: 1px solid var(--border); margin: 20px 0;">
        <div id="admin-list" style="width: 100%; display:flex; flex-direction:column; align-items:center;"></div>
    </div>

    <div id="chat-ui">
        <header>
            <span style="font-weight: bold; color: var(--primary);">Family Chat</span>
            <div style="display:flex; gap:8px;">
                <button id="admin-btn" class="btn-icon hidden" onclick="openAdmin()">⚙️</button>
                <button class="btn-icon" onclick="location.reload()">↻</button>
                <button onclick="logout()" style="background:#da3633; border:none; color:white; padding:5px 10px; border-radius:4px; font-weight:bold;">Exit</button>
            </div>
        </header>
        <div id="messages"></div>
        <div class="input-area"><div id="msg-in" contenteditable="true"></div><button onclick="send()" style="width:70px; height:45px;">Send</button></div>
    </div>

    <script>
        const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbyXc0Hx3ohoLBMaTgNHMixZFEuVrpJAGlmvrGM4CzbMsPLhEt1RxpuS7NcqigSRr8y9/exec";
        
        let myUser = "", myColor = "#238636", myTag = "", refreshInterval, selectedColor = "#238636";
        const colors = ['#238636','#39ff14','#00d4ff','#ff85a2','#ff9100','#f8e71c','#bd10e0','#9013fe','#50e3c2','#ff5733','#c70039','#900c3f','#581845','#1abc9c','#2ecc71','#3498db','#9b59b6','#f1c40f','#e67e22','#e74c3c'];

        window.onload = () => {
            const grid = document.getElementById('color-grid');
            if(grid) {
                colors.forEach(c => {
                    const d = document.createElement('div'); d.style.background = c; d.style.height="30px"; d.style.borderRadius="4px"; d.style.cursor="pointer"; d.onclick = () => selectedColor = c;
                    grid.appendChild(d);
                });
            }

            document.getElementById('msg-in').addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); send(); }
            });

            const savedU = localStorage.getItem('chat_user'), savedP = localStorage.getItem('chat_pass');
            if (savedU && savedP) attemptLogin(savedU, savedP);
        };

        async function attemptLogin(u, p) {
            showSpinner("Logging in...");
            try {
                const res = await fetch(`${WEB_APP_URL}?action=login&user=${encodeURIComponent(u)}&pass=${encodeURIComponent(p)}`);
                const data = await res.json();
                if (data.success) {
                    myUser = u; myColor = data.color; myTag = data.tag;
                    localStorage.setItem('chat_user', u); localStorage.setItem('chat_pass', p);
                    if (myTag.toUpperCase() === "ADMIN") document.getElementById('admin-btn').classList.remove('hidden');
                    document.getElementById('setup').classList.add('hidden');
                    document.getElementById('chat-ui').style.display = 'flex';
                    refreshInterval = setInterval(refresh, 4000); refresh();
                } else alert(data.error || "Login Failed");
            } catch(e) { alert("Connection error."); }
            hideSpinner();
        }

        async function openAdmin() {
            toggleScreens('admin');
            const list = document.getElementById('admin-list');
            list.innerHTML = "<div style='margin-top:20px; color:#8b949e;'>Fetching list...</div>";
            try {
                const url = `${WEB_APP_URL}?action=get_users&user=${encodeURIComponent(myUser)}&pass=${encodeURIComponent(localStorage.getItem('chat_pass'))}&v=${Date.now()}`;
                const res = await fetch(url);
                const users = await res.json();
                list.innerHTML = ""; 
                if (!users || users.length === 0) { list.innerHTML = "No members found."; return; }

                users.forEach(u => {
                    if(!u.user) return;
                    const div = document.createElement('div'); div.className = "admin-item";
                    div.innerHTML = `
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <b style="color:${u.color || '#fff'}">${u.user}</b> 
                            <span style="font-size:10px; opacity:0.6;">${u.tag} [${u.status}]</span>
                        </div>
                        <div style="margin-top:8px; display:flex; gap:5px;">
                            ${u.isReq ? `<button onclick="adminAction('${u.user}','approve')" style="background:green; font-size:10px; height:28px; flex:1; color:white; border-radius:4px; border:none;">Approve</button>` : ''}
                            <button onclick="adminAction('${u.user}','deny')" style="background:#da3633; font-size:10px; height:28px; flex:1; color:white; border-radius:4px; border:none;">${u.isReq ? 'Deny' : 'Remove'}</button>
                        </div>`;
                    list.appendChild(div);
                });
            } catch (e) { list.innerHTML = "Error loading admin panel."; }
        }

        async function clearChat() {
            if (!confirm("Are you sure?")) return;
            showSpinner("Clearing...");
            await fetch(WEB_APP_URL, { method: "POST", mode: "no-cors", body: JSON.stringify({action: "clear_chat"}) });
            setTimeout(() => { hideSpinner(); refresh(); }, 1500);
        }

        async function adminAction(target, action) {
            showSpinner("Processing...");
            await fetch(WEB_APP_URL, { method: "POST", mode: "no-cors", body: JSON.stringify({action: "admin_manage", target: target, subAction: action}) });
            setTimeout(openAdmin, 1500);
        }

        async function handleSignup() {
            showSpinner("Submitting...");
            await fetch(WEB_APP_URL, { method: "POST", mode: "no-cors", body: JSON.stringify({action:"signup", username:document.getElementById('reg-user').value, password:document.getElementById('reg-pass').value, color:selectedColor}) });
            alert("Sent! Wait for admin approval."); hideSpinner(); toggleScreens('login');
        }

        function toggleScreens(scr) {
            document.getElementById('setup').classList.add('hidden'); document.getElementById('signup-ui').classList.add('hidden'); document.getElementById('admin-ui').classList.add('hidden'); document.getElementById('chat-ui').style.display = 'none';
            if (scr === 'login') document.getElementById('setup').classList.remove('hidden');
            if (scr === 'signup') document.getElementById('signup-ui').classList.remove('hidden');
            if (scr === 'admin') document.getElementById('admin-ui').classList.remove('hidden');
            if (scr === 'chat') document.getElementById('chat-ui').style.display = 'flex';
        }

        function showSpinner(t) { document.getElementById('action-text').innerText = t; document.getElementById('action-overlay').style.display = 'flex'; }
        function hideSpinner() { document.getElementById('action-overlay').style.display = 'none'; }
        function logout() { localStorage.clear(); location.reload(); }

        async function send() {
            const i = document.getElementById('msg-in'); let m = i.innerText; 
            if (!m.trim()) return; i.innerHTML = "";
            renderMessage(myUser, m, true, myColor, myTag);
            await fetch(WEB_APP_URL, { method: "POST", mode: "no-cors", body: JSON.stringify({username:myUser, message:m, color:myColor, tag:myTag}) });
        }

        async function refresh() {
            try {
                const res = await fetch(`${WEB_APP_URL}?action=refresh`);
                const data = await res.json();
                const box = document.getElementById('messages'); box.innerHTML = "";
                data.messages.forEach(m => renderMessage(m.username, m.message, m.username === myUser, m.color, m.tag));
            } catch(e) {}
        }

        function renderMessage(u, t, me, c, tag) {
            const box = document.getElementById('messages'), div = document.createElement('div');
            div.className = `msg ${me ? 'me' : ''}`; div.style[me ? 'borderRight' : 'borderLeft'] = `4px solid ${c}`;
            const imgR = /(https?:\/\/.*\.(?:png|jpg|jpeg|gif|webp))/i;
            let content = imgR.test(t.trim()) ? `<img src="${t.trim()}" onload="document.getElementById('messages').scrollTop = document.getElementById('messages').scrollHeight;">` : t;
            div.innerHTML = `<b style="color:${c}; font-size:12px;">${u} <span style="font-size:8px; opacity:0.5;">${tag}</span></b><div style="margin-top:4px;">${content}</div>`;
            box.appendChild(div); box.scrollTop = box.scrollHeight;
        }
    </script>
</body>
</html>
