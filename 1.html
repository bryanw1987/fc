<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Private Room</title>
    <style>
        :root { --bg: #0d1117; --card: #161b22; --primary: #238636; --text: #c9d1d9; --border: #30363d; }
        * { box-sizing: border-box; }
        body { margin: 0; font-family: -apple-system, sans-serif; background: var(--bg); color: var(--text); height: 100dvh; display: flex; flex-direction: column; overflow: hidden; }

        #setup, #signup-ui { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; padding: 20px; }
        .form-card { background: var(--card); padding: 25px; border-radius: 12px; border: 1px solid var(--border); width: 100%; max-width: 350px; display: flex; flex-direction: column; gap: 12px; }
        input { width: 100%; height: 45px; padding: 0 12px; border-radius: 8px; border: 1px solid var(--border); background: #0d1117; color: white; outline: none; font-size: 16px; }
        button { height: 45px; background: var(--primary); border: none; border-radius: 8px; color: white; font-weight: bold; cursor: pointer; }
        
        .color-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; margin: 10px 0; }
        .color-box { width: 100%; aspect-ratio: 1/1; border-radius: 4px; cursor: pointer; border: 2px solid transparent; }
        .color-box.selected { border-color: white; transform: scale(1.1); }

        header { background: var(--card); padding: 10px 15px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        #chat-ui { display: none; flex-direction: column; height: 100dvh; }
        #messages { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 12px; }
        .msg { background: var(--card); padding: 10px; border-radius: 12px; max-width: 85%; width: fit-content; border: 1px solid var(--border); }
        .msg.me { align-self: flex-end; background: #21262d; }
        .sys-msg { align-self: center; color: #00a8ff; font-size: 13px; font-weight: bold; margin: 5px 0; }
        .tag-label { font-size: 0.65rem; font-weight: 800; opacity: 0.8; background: rgba(255,255,255,0.1); padding: 1px 4px; border-radius: 4px; margin-left: 5px; }
        .input-area { padding: 15px; background: var(--card); display: flex; gap: 10px; border-top: 1px solid var(--border); }
        .hidden { display: none !important; }
        .switch-link { color: #58a6ff; font-size: 14px; text-decoration: underline; cursor: pointer; text-align: center; margin-top: 10px; }
    </style>
</head>
<body>

    <div id="loading-overlay" class="hidden" style="position:fixed; inset:0; background:var(--bg); z-index:100; display:flex; align-items:center; justify-content:center;">Checking Access...</div>

    <div id="setup">
        <div class="form-card">
            <h2>Login</h2>
            <input type="text" id="user-in" placeholder="Username">
            <input type="password" id="pass-in" placeholder="Password">
            <button onclick="handleLoginClick()">Join Chat</button>
            <span class="switch-link" onclick="toggleScreens()">Need an account? Sign up</span>
        </div>
    </div>

    <div id="signup-ui" class="hidden">
        <div class="form-card">
            <h2>Request Access</h2>
            <input type="text" id="reg-user" placeholder="Choose Username">
            <input type="password" id="reg-pass" placeholder="Choose Password">
            <div style="font-size: 12px; color: #8b949e;">Select your message color:</div>
            <div class="color-grid" id="color-grid"></div>
            <button onclick="handleSignup()">Submit Request</button>
            <span class="switch-link" onclick="toggleScreens()">Back to Login</span>
        </div>
    </div>

    <div id="chat-ui">
        <header><span id="header-user">Chat</span><button onclick="logout()" style="background:#da3633; height:30px; font-size:12px; padding:0 10px; border-radius:4px; border:none; color:white;">Log Out</button></header>
        <div id="messages"></div>
        <div class="input-area"><input type="text" id="msg-in" placeholder="Message..." onkeypress="if(event.key==='Enter') send()"><button onclick="send()" style="width:70px;">Send</button></div>
    </div>

    <script>
        const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbyBAbm9Dw4kYuJCoqhUm9p2ytKQ1yttdLRJeLG2tO0AjSmSz8TNOOV23NSWoEhLkX93/exec";
        let myUser = "", myColor = "#238636", myTag = "", refreshInterval, selectedColor = "#238636";

        const colors = ['#238636','#39ff14','#00d4ff','#ff85a2','#ff9100','#f8e71c','#bd10e0','#9013fe','#50e3c2','#ff5733','#c70039','#900c3f','#581845','#1abc9c','#2ecc71','#3498db','#9b59b6','#f1c40f','#e67e22','#e74c3c'];

        window.onload = () => {
            const grid = document.getElementById('color-grid');
            colors.forEach(c => {
                const d = document.createElement('div');
                d.className = 'color-box'; d.style.backgroundColor = c;
                d.onclick = () => { 
                    document.querySelectorAll('.color-box').forEach(b => b.classList.remove('selected'));
                    d.classList.add('selected'); selectedColor = c;
                };
                grid.appendChild(d);
            });
            autoLogin();
        };

        async function autoLogin() {
            const u = localStorage.getItem('chat_user'), p = localStorage.getItem('chat_pass');
            if (u && p) {
                document.getElementById('loading-overlay').classList.remove('hidden');
                const ok = await attemptLogin(u, p, true);
                if (!ok) { document.getElementById('loading-overlay').classList.add('hidden'); }
            }
        }

        function toggleScreens() {
            document.getElementById('setup').classList.toggle('hidden');
            document.getElementById('signup-ui').classList.toggle('hidden');
        }

        async function handleSignup() {
            const u = document.getElementById('reg-user').value, p = document.getElementById('reg-pass').value;
            if (!u || !p) return alert("Fill all fields");
            await fetch(WEB_APP_URL, { method: "POST", mode: "no-cors", body: JSON.stringify({action: "signup", username: u, password: p, color: selectedColor}) });
            alert("Request sent! Ask an admin to approve you.");
            toggleScreens();
        }

        async function attemptLogin(user, pass, isAuto) {
            try {
                const res = await fetch(`${WEB_APP_URL}?action=login&user=${encodeURIComponent(user)}&pass=${encodeURIComponent(pass)}`);
                const data = await res.json();
                if (data.success) {
                    if (!isAuto) await fetch(WEB_APP_URL, { method: "POST", mode: "no-cors", body: JSON.stringify({message: `${user} has entered the chat.`, isSystem: true}) });
                    localStorage.setItem('chat_user', user); localStorage.setItem('chat_pass', pass);
                    myUser = user; myColor = data.color; myTag = data.tag;
                    document.documentElement.style.setProperty('--primary', myColor);
                    document.getElementById('header-user').innerText = `${myUser} (${myTag})`;
                    document.getElementById('loading-overlay').classList.add('hidden');
                    document.getElementById('setup').classList.add('hidden');
                    document.getElementById('chat-ui').style.display = 'flex';
                    refreshInterval = setInterval(refresh, 4000); refresh(); return true;
                } else if (data.banned) { alert("Banned."); logout(false); }
                return false;
            } catch(e) { return false; }
        }

        function handleLoginClick() {
            const u = document.getElementById('user-in').value, p = document.getElementById('pass-in').value;
            attemptLogin(u, p, false).then(ok => { if(!ok) alert("Login Failed"); });
        }

        async function logout(notify = true) {
            if (notify && myUser) await fetch(WEB_APP_URL, { method: "POST", mode: "no-cors", body: JSON.stringify({message: `${myUser} has left the chat.`, isSystem: true}) });
            localStorage.clear(); clearInterval(refreshInterval); location.reload();
        }

        async function send() {
            const i = document.getElementById('msg-in'), m = i.value; if (!m.trim()) return;
            i.value = ""; renderMessage(myUser, m, true, myColor, myTag);
            await fetch(WEB_APP_URL, { method: "POST", mode: "no-cors", body: JSON.stringify({username: myUser, message: m, color: myColor, tag: myTag, isSystem: false}) });
        }

        async function refresh() {
            try {
                const u = localStorage.getItem('chat_user'), p = localStorage.getItem('chat_pass');
                const res = await fetch(`${WEB_APP_URL}?action=refresh&user=${encodeURIComponent(u)}&pass=${encodeURIComponent(p)}`);
                const data = await res.json();
                if (!data.authSuccess) { logout(false); return; }
                const box = document.getElementById('messages'); box.innerHTML = "";
                data.messages.forEach(m => renderMessage(m.username, m.message, m.username === myUser, m.color, m.tag));
            } catch(e) {}
        }

        function renderMessage(u, t, me, c, tag) {
            const box = document.getElementById('messages'), div = document.createElement('div');
            if (u === "SYSTEM") { div.className = "sys-msg"; div.innerText = t; } 
            else {
                div.className = `msg ${me ? 'me' : ''}`; div.style[me ? 'borderRight' : 'borderLeft'] = `4px solid ${c}`;
                div.innerHTML = `<b style="color:${c}; font-size:12px;">${u} <span class="tag-label">(${tag.toUpperCase()})</span></b><div style="margin-top:4px;">${t}</div>`;
            }
            box.appendChild(div); box.scrollTop = box.scrollHeight;
        }
    </script>
</body>
</html>
